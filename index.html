<html>
    <head>
        <title>TerraForm</title>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100% }
            .menu { margin: 20px;}
        </style>
    </head>
    <body>
        <script src="three.js"></script>

        <script id="fragment_shh" type="x-shader/x-fragment">
            #ifdef GL_ES
            precision highp float;
            #endif

            uniform float radius;
            uniform sampler2D tOne;
            uniform sampler2D tSec;

            uniform vec2 mouse;

            varying vec2 vUv;
            varying vec3 vPos;


            void main(void)
            {
                float r = sqrt((vPos.x - mouse.x) * (vPos.x - mouse.x)  + (vPos.y - mouse.y) *  (vPos.y - mouse.y));
                vec3 c;
                vec4 Cdirt = texture2D(tOne, vUv); //dirt
                vec4 Cgrass = texture2D(tSec, vUv); //grass

                float mouse_x = mouse[0];
                float mouse_y = mouse[1];

                if (r <= radius){
                    c = Cdirt.rgb;
                } else {
                    c = Cgrass.rgb;
                }

                // c = Cdirt.rgb * 0.2 + Cgrass.rgb * 0.8;
                gl_FragColor = vec4(c, 1.0);
            }

        </script>

        <script id="vertex_shh" type="x-shader/x-vertex">
            attribute vec3 vposition;
            uniform float radius;
            varying vec2 vUv;
            // varying vec4 pos;
            uniform float vert;
            varying vec3 vPos;
            uniform float rand;
            uniform int mousedown;
            uniform vec2 mouse;
            void main()
            {
                vec3 newPos = position;
                vPos = vposition;
                vUv = uv;
                float r = sqrt((position.x - mouse.x) * (position.x - mouse.x)  + (position.y - mouse.y) *  (position.y - mouse.y));
                if (r < radius){
                    // vec3 newPos = position + vec3(0.0,0.0,0.01);
                    // newPos = position + 2.0 * normal;
                    newPos.z = vert;
                }
                // vec3 newPos = position + normal * (position.x - 5.0);
                vec4 mvPosition = modelViewMatrix * vec4( newPos, 1.0 );
                // pos = gl_Position;
                gl_Position = projectionMatrix * mvPosition;
            }

        </script>



        <script>
            //Set up the scene
            var scene = new THREE.Scene();
            var camera = new THREE.PerspectiveCamera( 45, window.innerWidth/window.innerHeight, 0.1, 1000 );

            camera.position.set(15,15,18);
            camera.up = new THREE.Vector3(0,0,1);
            camera.lookAt(new THREE.Vector3(-1,-1,-1));

            var renderer = new THREE.WebGLRenderer(
                {antialias: true});
            // renderer.setSize( window.innerWidth, window.innerHeight );
            renderer.setSize( 640, 480 );
            renderer.setClearColor( 0xFDFFF0, 1);
            document.body.appendChild( renderer.domElement );

            var raycaster = new THREE.Raycaster(); // create once and reuse
            var mouse = new THREE.Vector2();

            var pLength = 20;
            var pSeg = 100;
            var radius = 2;

            var maxheight = 4;
            var minheight = -2;

            // lighting
            var light = new THREE.DirectionalLight( 0xffffff, 1.5 );
            light.position.set( 1, 1, 1 ).normalize();
            scene.add(light);

            //load texture
            THREE.ImageUtils.crossOrigin = "anonymous";  // or
            THREE.ImageUtils.crossOrigin = "";// the default
            var texture = new THREE.TextureLoader().load("textures/grass_texture.jpeg");
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(8,8);
            var material = new THREE.MeshPhongMaterial( { /*map: texture,*/ vertexColors: THREE.VertexColors } );
            // var meshFaceMaterial = new THREE.MeshFaceMaterial( [material] );

            //trying blend
            var vertShader = document.getElementById('vertex_shh').innerHTML;
            var fragShader = document.getElementById('fragment_shh').innerHTML;

            //var attributes = {}; // custom attributes

            dirt_tex = new THREE.TextureLoader().load( "textures/dirt_texture.gif" )
            water_tex = new THREE.TextureLoader().load( "textures/water.png" )

            var uniforms = {    // custom uniforms (your textures)
              tOne: { type: "t", value: dirt_tex},
              tSec: { type: "t", value: new THREE.TextureLoader().load("textures/grass_texture.jpeg") }, // might need to change this to new THREE.TextureLoader().load("textures/grass_texture.jpeg");
              vert: {type: "f", value: zval},
              mouse: { type: "v2", value: new THREE.Vector2() },
              mousedown: { type: "i", value: 0},
              radius: {type: "f", value: 2.0},
              rand:   {type: "f", value: 1.0}
            };

            // var geometry = new THREE.PlaneGeometry(pLength,pLength,pSeg,pSeg);
            var geometry = new THREE.PlaneBufferGeometry( pLength, pLength, pSeg, pSeg );
            var vertices = [];


            var mesh = new THREE.MeshBasicMaterial( {
                    color: 0xffffff,
                    wireframe: true,
                    side: THREE.DoubleSide,
                    alphaTest: 0
                } );
            var flatmesh = new THREE.MeshBasicMaterial( { color: 0xffccbb, side: THREE.DoubleSide, alphaTest: 0, visible: false } );

            var material_shh = new THREE.ShaderMaterial({
              uniforms: uniforms,
              vertexShader: vertShader,
              fragmentShader: fragShader

            });
            var flatplane = new THREE.Mesh(new THREE.PlaneGeometry(pLength,pLength,pSeg,pSeg), flatmesh);

            console.log(vertices.length);
            // var attributes = {    // custom uniforms (your textures)
            //   vposition: { type: "f", value: plane.geometry.attributes.position.array} // might
            // };
            var plane = new THREE.Mesh(geometry, material_shh); //testing
            geometry.addAttribute( "vposition", new THREE.BufferAttribute( plane.geometry.attributes.position.array, 3) );
            geometry.attributes.position.needsUpdate = true;
            scene.add(flatplane);
            scene.add(plane);

            var time = 0.0;
            camera.position.z = 15;

            var mousedownID = -1;  //Global ID of mouse down interval
            function mousedown(event) {
                mouse.x = (event.clientX / renderer.domElement.width ) * 2 - 1;
                mouse.y = - (event.clientY / renderer.domElement.height ) * 2 + 1;
                uniforms.mousedown.value = 1;
                zval += direction * 0.5;
                uniforms.vert.value = zval;
                var intersect = raycaster.intersectObject(flatplane);
                if (intersect.length > 0){
                        console.log("intersected");
                        mouse.x = intersect[0].object.geometry.vertices[intersect[0].face.a].x;
                        mouse.y = intersect[0].object.geometry.vertices[intersect[0].face.a].y;
                        console.log(mouse.x, mouse.y);
                        uniforms.mouse.value.x = mouse.x;
                        uniforms.mouse.value.y = mouse.y;
                    }
              // if(mousedownID==-1)  //Prevent multimple loops!
              //    mousedownID = setInterval(clickfun, 50); /*execute every 50ms*/
            }
            function mouseup(event) {
                uniforms.mousedown.value = 0;
               if(mousedownID!=-1) {  //Only stop if exists
                 clearInterval(mousedownID);
                 mousedownID=-1;
               }

            }
            function mousemove() {
                if (mousedownID!=-1){
                    mouse.x = (event.clientX / renderer.domElement.width ) * 2 - 1;
                    mouse.y = - (event.clientY / renderer.domElement.height ) * 2 + 1;
                    var intersect = raycaster.intersectObject(flatplane);
                    if (intersect.length > 0){
                        mouse.x = intersect[0].object.geometry.vertices[intersect[0].face.a].x;
                        mouse.y = intersect[0].object.geometry.vertices[intersect[0].face.a].y;
                        console.log(mouse.x, mouse.y);
                        uniforms.mouse.value.x = mouse.x;
                        uniforms.mouse.value.y = mouse.y;
                    }
                }
            }


            var direction = 1;
            function setRaise(sign) {
                direction = sign;
            }
            //Assign events
            document.addEventListener("mousedown", mousedown);
            document.addEventListener("mouseup", mouseup);
            //Also clear the interval when user leaves the window with mouse
            document.addEventListener("mouseout", mouseup);
            document.addEventListener("mousemove", mousemove);

            //window.onclick = clickfun;
            var zval = 0.0;
            // function clickfun(){
            //     // mouse.x = (event.clientX / renderer.domElement.width ) * 2 - 1;
            //     // mouse.y = - (event.clientY / renderer.domElement.height ) * 2 + 1;
            //     // raycaster.setFromCamera( mouse, camera );

            //     // // var intersect = raycaster.intersectObject(flatplane);
            //     // var intersect = raycaster.intersectObject(flatplane);
            //     // // console.log(intersect[0].face.color);
            //     // // intersect[0].face.color.setHex( Math.random() * 0xffffff );
            //     // // intersect[0].object.geometry.colorsNeedUpdate = true;
            //     // if ( intersect.length > 0 ) {
            //     //     var iPoint = intersect[0].point;
            //     //     for (var i = 0; i < plane.geometry.attributes.position.count; i++) {
            //     //         var gridPoint = plane.geometry.attributes.position[i];
            //     //         var dist = euclidean2D(iPoint.x, iPoint.y, gridPoint.x, gridPoint.y);
            //     //         if(dist < radius){
            //     //             plane.geometry.attributes.position[i].z += direction * raise(dist);
            //     //             if (plane.geometry.attributes.position[i].z > maxheight) {
            //     //                 plane.geometry.attributes.position[i].z = maxheight;
            //     //             }
            //     //             // plane.geometry.vertices[i].color.setHex(0xFF0000);
            //     //         }
            //     //     }

            //     //     console.log( intersect[ 0 ].point );
            //     //     uniforms.mouse.value.x = intersect[0].point.x;
            //     //     uniforms.mouse.value.y = intersect[0].point.y;
            //     // }

            // }

            function raise(dist){
                return Math.sqrt(radius - dist) * 0.1;
            }

            function euclidean2D(x1, y1, x2, y2){
                return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            }


            //manipulating the camera
            document.onkeydown = function(event) {
                if (!event)
                    event = window.event;
                var code = event.keyCode;
                if (event.charCode && code == 0)
                    code = event.charCode;
                switch(code){
                    case 37:
                        // left
                        camera.position.x += 0.15;
                        camera.position.y -= 0.15;
                        break;
                    case 38:
                        // up
                        // alert('up');
                        camera.position.x -= 0.15;
                        camera.position.y -= 0.15;
                        break;
                    case 39:
                        // right
                        camera.position.x -= 0.15;
                        camera.position.y += 0.15;
                        break;
                    case 40:
                        // down
                        camera.position.x += 0.15;
                        camera.position.y += 0.15;
                        break;
                }
                event.preventDefault();
            }

            function mousewheel( event )
            {
                //get wheel direction
                var d = ((typeof event.wheelDelta != "undefined")?
                            -event.wheelDelta:
                            event.detail);
                var zoomFactor = ((d>0)?1.02:0.98);

                camera.fov *= zoomFactor;
                camera.updateProjectionMatrix()
            }

            function setTexture(num){
                if (num == 0)
                    uniforms.tOne.value = water_tex;
                else
                    uniforms.tOne.value = dirt_tex;
            }

            window.addEventListener('DOMMouseScroll', mousewheel, false);
            window.addEventListener('mousewheel', mousewheel, false);

            uniforms.rand.value = Math.random() % 5;
            console.log(uniforms.rand.value );
            var render = function () {
                requestAnimationFrame( render );
                plane.geometry.verticesNeedUpdate = true;
                // for (var i = 0; i < plane.geometry.vertices.length; i++) {
                //     plane.geometry.vertices[i].z = Math.sin(time + i/8);
                // }

                // time += 0.05;
                // plane.rotation.z += 0.01;
                // uniforms.rand.value = Math.random() % 5;
                renderer.render(scene, camera);
            };


            render();
        </script>
        <div class="menu">
            <button type="button" onclick="setRaise(1)">Up</button>
            <button type="button" onclick="setRaise(-1)">Down</button>
            <button type="button" onclick="setTexture(0)">Water Brush</button>
            <button type="button" onclick="setTexture(1)">Dirt Brush</button>
            <button type="button">Click me</button>
            <button type="button">Click me</button>

        </div>
    </body>
</html>